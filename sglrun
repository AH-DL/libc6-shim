#!/usr/bin/env ruby
# encoding: UTF-8

SHIM_LIB = ENV['SHIM_DEBUG'] ? 'nvshim.debug.so' : 'nvshim.so'

`sysctl hw.nvidia.version` =~ /^hw.nvidia.version: NVIDIA UNIX x86_64 Kernel Module  ([\d\.+]+)/
driver_version = $1

raise if not driver_version

libmap = <<~E
  libGL.so   libGL.so.#{driver_version}
  libGL.so.1 libGL.so.#{driver_version}

  libnvidia-ptxjitcompiler.so.1 libnvidia-ptxjitcompiler.so.#{driver_version}

  libc.so.6       #{SHIM_LIB}
  libdl.so.2      #{SHIM_LIB}
  libm.so.6       #{SHIM_LIB}
  libpthread.so.0 #{SHIM_LIB}
  librt.so.x      #{SHIM_LIB}
E

ENV['LD_LIBMAP']          = libmap
ENV['LD_32_LIBMAP']       = libmap
ENV['LD_LIBRARY_PATH']    = [__dir__ + '/build/lib64', __dir__ + '/nvidia/lib64/tls', __dir__ + '/nvidia/lib64', ENV['LD_LIBRARY_PATH']   ].compact.join(':')
ENV['LD_32_LIBRARY_PATH'] = [__dir__ + '/build/lib32', __dir__ + '/nvidia/lib32/tls', __dir__ + '/nvidia/lib32', ENV['LD_32_LIBRARY_PATH']].compact.join(':')

ENV['VK_ICD_FILENAMES']   = __dir__ + '/nv_vk_icd.json'

exec *ARGV
