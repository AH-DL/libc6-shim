#!/usr/bin/env ruby
# encoding: UTF-8

if ARGV.length == 0
  STDERR.puts "run application with glibc shim:\n\s\s[env SHIM_DEBUG=1] #{File.basename($PROGRAM_NAME)} <application> [application args]"
  exit(0)
end

SHIM_LIB = ENV['SHIM_DEBUG'] == '1' ? 'libc6-debug.so' : 'libc6.so'

def libmap(libdir_suffix)

  lmap = {
    'ld-linux.so.2'        => SHIM_LIB,
    'ld-linux-x86-64.so.2' => SHIM_LIB,
    'libc.so.6'            => SHIM_LIB,
    'libdl.so.2'           => SHIM_LIB,
    'libm.so.6 '           => SHIM_LIB,
    'libpthread.so.0'      => SHIM_LIB,
    'librt.so.1'           => SHIM_LIB,
    'bsd-librt.so.1'       => "/usr/lib#{libdir_suffix}/librt.so.1",
    'libcxxrt.so.1'        => ('fakecxxrt.so' if ENV['SHIM_FAKECXXRT'] == '1')
  }

  lmap.compact.map{|k, v| '%-40s %s' % [k, v]}.join("\n")
end

ENV['LD_LIBMAP']          = [libmap(''),   ENV['LD_LIBMAP']   ].join("\n")
ENV['LD_32_LIBMAP']       = [libmap('32'), ENV['LD_32_LIBMAP']].join("\n")

ENV['LD_LIBRARY_PATH']    = [File.join(__dir__, '../lib64'), ENV['LD_LIBRARY_PATH']   ].compact.join(':')
ENV['LD_32_LIBRARY_PATH'] = [File.join(__dir__, '../lib32'), ENV['LD_32_LIBRARY_PATH']].compact.join(':')

exec([ARGV[0]] * 2, *ARGV[1..-1])
