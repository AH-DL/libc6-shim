#!/usr/bin/env ruby
# encoding: UTF-8

SHIM_LIB =
  if ENV['SHIM_DEBUG'] == '1'
    'nvshim.debug.so'
  else
    'nvshim.so'
  end

def libmap(libdir_suffix)

  lmap = {
    'ld-linux.so.2'        => SHIM_LIB,
    'ld-linux-x86-64.so.2' => SHIM_LIB,
    'libc.so.6'            => SHIM_LIB,
    'libdl.so.2'           => SHIM_LIB,
    'libm.so.6 '           => SHIM_LIB,
    'libpthread.so.0'      => SHIM_LIB,
    'librt.so.1'           => SHIM_LIB,
    'bsd-librt.so.1'       => "/usr/lib#{libdir_suffix}/librt.so.1",
    'libcxxrt.so.1'        => ('fakecxxrt.so' if ENV['SHIM_FAKECXXRT'] == '1')
  }

  lmap.compact.map{|k, v| '%-40s %s' % [k, v]}.join("\n")
end

ENV['LD_LIBMAP']          = [libmap(''),   ENV['LD_LIBMAP']   ].join("\n")
ENV['LD_32_LIBMAP']       = [libmap('32'), ENV['LD_32_LIBMAP']].join("\n")

ENV['LD_LIBRARY_PATH']    = [File.join(__dir__, '../lib64'), ENV['LD_LIBRARY_PATH']   ].compact.join(':')
ENV['LD_32_LIBRARY_PATH'] = [File.join(__dir__, '../lib32'), ENV['LD_32_LIBRARY_PATH']].compact.join(':')

exec *ARGV
